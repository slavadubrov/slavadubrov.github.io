<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 600">
  <defs>
    <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
      <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e8e8e8" stroke-width="0.5"/>
    </pattern>
    <marker id="arrowDark" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto" markerUnits="userSpaceOnUse">
      <path d="M 0 0 L 8 4 L 0 8 z" fill="#1a365d"/>
    </marker>
    <marker id="arrowPurple" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto" markerUnits="userSpaceOnUse">
      <path d="M 0 0 L 8 4 L 0 8 z" fill="#7c3aed"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="900" height="600" fill="#fafafa"/>
  <rect width="900" height="600" fill="url(#grid)"/>

  <!-- Title -->
  <text x="450" y="35" text-anchor="middle" fill="#1a365d" font-family="system-ui" font-size="22" font-weight="700">mHC: Manifold-Constrained Hyper-Connections</text>
  <text x="450" y="58" text-anchor="middle" fill="#64748b" font-family="system-ui" font-size="12">Three learnable mappings with stability constraints</text>

  <!-- ========== Main Flow ========== -->

  <!-- Input Streams -->
  <g transform="translate(60, 100)">
    <text x="45" y="-10" text-anchor="middle" fill="#64748b" font-family="system-ui" font-size="11">Input Streams</text>
    <rect x="0" y="0" width="90" height="32" rx="4" fill="#e0f2fe" stroke="#0284c7" stroke-width="1.5"/>
    <text x="45" y="21" text-anchor="middle" fill="#0369a1" font-family="system-ui" font-size="13" font-weight="600">x₁, x₂, ..., xₙ</text>
    <text x="45" y="50" text-anchor="middle" fill="#64748b" font-family="system-ui" font-size="11">H^(l-1)</text>
  </g>

  <!-- Arrow down to H^pre -->
  <line x1="105" y1="160" x2="105" y2="190" stroke="#1a365d" stroke-width="2" marker-end="url(#arrowDark)"/>

  <!-- H^pre box -->
  <g transform="translate(30, 200)">
    <rect x="0" y="0" width="150" height="70" rx="8" fill="#fff7ed" stroke="#f97316" stroke-width="2"/>
    <text x="75" y="25" text-anchor="middle" fill="#f97316" font-family="system-ui" font-size="14" font-weight="700">H^pre</text>
    <text x="75" y="45" text-anchor="middle" fill="#9a3412" font-family="system-ui" font-size="11">Aggregation</text>
    <text x="75" y="62" text-anchor="middle" fill="#64748b" font-family="system-ui" font-size="10">σ(·) → non-negative</text>
  </g>

  <!-- Arrow to transformer -->
  <line x1="105" y1="275" x2="105" y2="310" stroke="#1a365d" stroke-width="2" marker-end="url(#arrowDark)"/>

  <!-- Transformer Block -->
  <g transform="translate(30, 320)">
    <rect x="0" y="0" width="150" height="60" rx="8" fill="white" stroke="#1a365d" stroke-width="2.5"/>
    <text x="75" y="28" text-anchor="middle" fill="#1a365d" font-family="system-ui" font-size="15" font-weight="700">Transformer</text>
    <text x="75" y="48" text-anchor="middle" fill="#64748b" font-family="system-ui" font-size="12">T(·)</text>
  </g>

  <!-- Arrow to H^post -->
  <line x1="105" y1="385" x2="105" y2="420" stroke="#1a365d" stroke-width="2" marker-end="url(#arrowDark)"/>

  <!-- H^post box -->
  <g transform="translate(30, 430)">
    <rect x="0" y="0" width="150" height="70" rx="8" fill="#faf5ff" stroke="#7c3aed" stroke-width="2"/>
    <text x="75" y="25" text-anchor="middle" fill="#7c3aed" font-family="system-ui" font-size="14" font-weight="700">H^post</text>
    <text x="75" y="45" text-anchor="middle" fill="#6b21a8" font-family="system-ui" font-size="11">Expansion</text>
    <text x="75" y="62" text-anchor="middle" fill="#64748b" font-family="system-ui" font-size="10">σ(·) → non-negative</text>
  </g>

  <!-- ========== Residual Path ========== -->

  <!-- Residual branch from input -->
  <path d="M 170 116 L 260 116" stroke="#10b981" stroke-width="2.5" fill="none"/>

  <!-- H^res box (main feature!) -->
  <g transform="translate(265, 80)">
    <rect x="0" y="0" width="180" height="100" rx="8" fill="#f0fdf4" stroke="#10b981" stroke-width="2.5"/>
    <text x="90" y="28" text-anchor="middle" fill="#10b981" font-family="system-ui" font-size="16" font-weight="700">H^res</text>
    <text x="90" y="48" text-anchor="middle" fill="#047857" font-family="system-ui" font-size="12">Residual Mixing</text>

    <!-- Sinkhorn badge -->
    <rect x="20" y="58" width="140" height="32" rx="4" fill="#10b981"/>
    <text x="90" y="80" text-anchor="middle" fill="white" font-family="system-ui" font-size="11" font-weight="600">Sinkhorn-Knopp (t=20)</text>
  </g>

  <!-- Down arrow from H^res -->
  <path d="M 355 185 L 355 350 L 200 350" stroke="#10b981" stroke-width="2.5" fill="none" marker-end="url(#arrowDark)"/>

  <!-- Plus symbol for addition -->
  <g transform="translate(195, 335)">
    <circle cx="0" cy="15" r="18" fill="#1a365d"/>
    <text x="0" y="21" text-anchor="middle" fill="white" font-family="system-ui" font-size="18" font-weight="700">+</text>
  </g>

  <!-- ========== Doubly Stochastic Properties ========== -->

  <g transform="translate(500, 80)">
    <rect x="0" y="0" width="360" height="200" rx="10" fill="white" stroke="#e2e8f0" stroke-width="1.5"/>
    <text x="180" y="28" text-anchor="middle" fill="#1a365d" font-family="system-ui" font-size="14" font-weight="700">Doubly Stochastic Constraint</text>

    <!-- Matrix visualization -->
    <g transform="translate(20, 45)">
      <!-- 3x3 grid showing doubly stochastic -->
      <rect x="0" y="0" width="100" height="100" fill="#f8fafc" stroke="#94a3b8" stroke-width="1"/>
      <!-- Grid lines -->
      <line x1="33" y1="0" x2="33" y2="100" stroke="#cbd5e1" stroke-width="1"/>
      <line x1="66" y1="0" x2="66" y2="100" stroke="#cbd5e1" stroke-width="1"/>
      <line x1="0" y1="33" x2="100" y2="33" stroke="#cbd5e1" stroke-width="1"/>
      <line x1="0" y1="66" x2="100" y2="66" stroke="#cbd5e1" stroke-width="1"/>
      <!-- Sample values -->
      <text x="16" y="22" text-anchor="middle" fill="#1a365d" font-family="system-ui" font-size="10">.28</text>
      <text x="50" y="22" text-anchor="middle" fill="#1a365d" font-family="system-ui" font-size="10">.45</text>
      <text x="83" y="22" text-anchor="middle" fill="#1a365d" font-family="system-ui" font-size="10">.27</text>
      <text x="16" y="55" text-anchor="middle" fill="#1a365d" font-family="system-ui" font-size="10">.40</text>
      <text x="50" y="55" text-anchor="middle" fill="#1a365d" font-family="system-ui" font-size="10">.09</text>
      <text x="83" y="55" text-anchor="middle" fill="#1a365d" font-family="system-ui" font-size="10">.51</text>
      <text x="16" y="88" text-anchor="middle" fill="#1a365d" font-family="system-ui" font-size="10">.32</text>
      <text x="50" y="88" text-anchor="middle" fill="#1a365d" font-family="system-ui" font-size="10">.46</text>
      <text x="83" y="88" text-anchor="middle" fill="#1a365d" font-family="system-ui" font-size="10">.22</text>

      <!-- Row sums -->
      <text x="120" y="22" text-anchor="middle" fill="#10b981" font-family="system-ui" font-size="10" font-weight="600">=1</text>
      <text x="120" y="55" text-anchor="middle" fill="#10b981" font-family="system-ui" font-size="10" font-weight="600">=1</text>
      <text x="120" y="88" text-anchor="middle" fill="#10b981" font-family="system-ui" font-size="10" font-weight="600">=1</text>

      <!-- Column sums -->
      <text x="16" y="115" text-anchor="middle" fill="#10b981" font-family="system-ui" font-size="10" font-weight="600">=1</text>
      <text x="50" y="115" text-anchor="middle" fill="#10b981" font-family="system-ui" font-size="10" font-weight="600">=1</text>
      <text x="83" y="115" text-anchor="middle" fill="#10b981" font-family="system-ui" font-size="10" font-weight="600">=1</text>
    </g>

    <!-- Properties list -->
    <g transform="translate(150, 50)">
      <text x="0" y="0" fill="#64748b" font-family="system-ui" font-size="11">✓ All entries ≥ 0</text>
      <text x="0" y="22" fill="#64748b" font-family="system-ui" font-size="11">✓ Each row sums to 1</text>
      <text x="0" y="44" fill="#64748b" font-family="system-ui" font-size="11">✓ Each column sums to 1</text>
      <text x="0" y="75" fill="#1a365d" font-family="system-ui" font-size="11" font-weight="600">→ ||H^res|| ≤ 1</text>
      <text x="0" y="95" fill="#64748b" font-family="system-ui" font-size="10">(spectral norm bounded)</text>
      <text x="0" y="120" fill="#1a365d" font-family="system-ui" font-size="11" font-weight="600">→ Signal preserved</text>
      <text x="0" y="140" fill="#64748b" font-family="system-ui" font-size="10">(no explosion/vanishing)</text>
    </g>
  </g>

  <!-- ========== Output ========== -->

  <!-- Arrow down to output -->
  <line x1="105" y1="505" x2="105" y2="545" stroke="#1a365d" stroke-width="2" marker-end="url(#arrowDark)"/>

  <!-- Output Streams -->
  <g transform="translate(60, 555)">
    <rect x="0" y="0" width="90" height="32" rx="4" fill="#ddd6fe" stroke="#7c3aed" stroke-width="1.5"/>
    <text x="45" y="21" text-anchor="middle" fill="#5b21b6" font-family="system-ui" font-size="13" font-weight="600">y₁, y₂, ..., yₙ</text>
  </g>
  <text x="105" y="600" text-anchor="middle" fill="#64748b" font-family="system-ui" font-size="11">Output Streams H^l</text>

  <!-- ========== Formula Summary ========== -->

  <g transform="translate(500, 310)">
    <rect x="0" y="0" width="360" height="100" rx="10" fill="white" stroke="#1a365d" stroke-width="1.5"/>
    <text x="180" y="28" text-anchor="middle" fill="#1a365d" font-family="system-ui" font-size="14" font-weight="700">Full mHC Layer Equation</text>

    <text x="20" y="58" fill="#1a365d" font-family="system-ui" font-size="13" font-weight="600">H^l = H^res · H^(l-1) + H^post · T(H^pre · H^(l-1))</text>

    <text x="20" y="85" fill="#64748b" font-family="system-ui" font-size="11">where H^res ∈ Birkhoff Polytope (doubly stochastic)</text>
  </g>

  <!-- ========== Results Badge ========== -->

  <g transform="translate(500, 440)">
    <rect x="0" y="0" width="175" height="80" rx="8" fill="white" stroke="#10b981" stroke-width="2"/>
    <text x="87" y="25" text-anchor="middle" fill="#10b981" font-family="system-ui" font-size="13" font-weight="700">Stability</text>
    <text x="87" y="48" text-anchor="middle" fill="#1a365d" font-family="system-ui" font-size="11">Amax Gain: ~1.6</text>
    <text x="87" y="68" text-anchor="middle" fill="#64748b" font-family="system-ui" font-size="10">(vs ~3000 in HC)</text>
  </g>

  <g transform="translate(685, 440)">
    <rect x="0" y="0" width="175" height="80" rx="8" fill="white" stroke="#f97316" stroke-width="2"/>
    <text x="87" y="25" text-anchor="middle" fill="#f97316" font-family="system-ui" font-size="13" font-weight="700">Efficiency</text>
    <text x="87" y="48" text-anchor="middle" fill="#1a365d" font-family="system-ui" font-size="11">Only +6.7% overhead</text>
    <text x="87" y="68" text-anchor="middle" fill="#64748b" font-family="system-ui" font-size="10">(with kernel fusion)</text>
  </g>

  <!-- Legend -->
  <g transform="translate(500, 555)">
    <rect x="0" y="0" width="360" height="35" rx="6" fill="#f8fafc" stroke="#e2e8f0" stroke-width="1"/>
    <circle cx="25" cy="17" r="8" fill="#f97316"/>
    <text x="40" y="22" fill="#64748b" font-family="system-ui" font-size="10">σ(·) constraint</text>
    <circle cx="135" cy="17" r="8" fill="#10b981"/>
    <text x="150" y="22" fill="#64748b" font-family="system-ui" font-size="10">Sinkhorn constraint</text>
    <circle cx="265" cy="17" r="8" fill="#7c3aed"/>
    <text x="280" y="22" fill="#64748b" font-family="system-ui" font-size="10">Expansion</text>
  </g>
</svg>
