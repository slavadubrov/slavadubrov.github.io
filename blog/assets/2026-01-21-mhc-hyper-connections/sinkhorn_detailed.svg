<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1050 450">
  <defs>
    <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
      <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e8e8e8" stroke-width="0.5"/>
    </pattern>
  </defs>

  <!-- Background -->
  <rect width="1050" height="450" fill="#fafafa"/>
  <rect width="1050" height="450" fill="url(#grid)"/>

  <!-- Title -->
  <text x="525" y="40" text-anchor="middle" fill="#1a365d" font-family="system-ui" font-size="26" font-weight="700">Implementing the Fix: The Sinkhorn Algorithm</text>
  <text x="525" y="68" text-anchor="middle" fill="#64748b" font-family="system-ui" font-size="14">Iteratively forcing Double Stochasticity.</text>

  <!-- Step 1: Raw Matrix -->
  <g transform="translate(25, 100)">
    <rect x="0" y="0" width="150" height="130" rx="6" fill="white" stroke="#1a365d" stroke-width="2"/>
    <text x="75" y="-12" text-anchor="middle" fill="#1a365d" font-family="system-ui" font-size="15" font-weight="600">Raw Matrix</text>

    <!-- Matrix values with negatives highlighted -->
    <text x="35" y="40" text-anchor="middle" fill="#dc2626" font-family="monospace" font-size="14" font-weight="600">-0.5</text>
    <text x="75" y="40" text-anchor="middle" fill="#1a365d" font-family="monospace" font-size="14">2.1</text>
    <text x="115" y="40" text-anchor="middle" fill="#1a365d" font-family="monospace" font-size="14">0.8</text>

    <text x="35" y="70" text-anchor="middle" fill="#1a365d" font-family="monospace" font-size="14">1.3</text>
    <text x="75" y="70" text-anchor="middle" fill="#dc2626" font-family="monospace" font-size="14" font-weight="600">-4.0</text>
    <text x="115" y="70" text-anchor="middle" fill="#1a365d" font-family="monospace" font-size="14">1.9</text>

    <text x="35" y="100" text-anchor="middle" fill="#1a365d" font-family="monospace" font-size="14">0.1</text>
    <text x="75" y="100" text-anchor="middle" fill="#1a365d" font-family="monospace" font-size="14">0.6</text>
    <text x="115" y="100" text-anchor="middle" fill="#dc2626" font-family="monospace" font-size="14" font-weight="600">-0.2</text>
  </g>

  <!-- Arrow 1 -->
  <g transform="translate(180, 155)">
    <rect x="0" y="-15" width="55" height="30" rx="15" fill="#f97316"/>
    <text x="27" y="5" text-anchor="middle" fill="white" font-family="system-ui" font-size="12" font-weight="600">Exp()</text>
    <line x1="55" y1="0" x2="75" y2="0" stroke="#f97316" stroke-width="3"/>
    <polygon points="80,0 70,-6 70,6" fill="#f97316"/>
  </g>

  <!-- Step 2: Positivity -->
  <g transform="translate(265, 100)">
    <rect x="0" y="0" width="150" height="130" rx="6" fill="white" stroke="#10b981" stroke-width="2"/>
    <text x="75" y="-12" text-anchor="middle" fill="#10b981" font-family="system-ui" font-size="15" font-weight="600">Positivity</text>

    <!-- All positive values -->
    <text x="35" y="40" text-anchor="middle" fill="#10b981" font-family="monospace" font-size="14">0.6</text>
    <text x="75" y="40" text-anchor="middle" fill="#10b981" font-family="monospace" font-size="14">7.9</text>
    <text x="115" y="40" text-anchor="middle" fill="#10b981" font-family="monospace" font-size="14">2.2</text>

    <text x="35" y="70" text-anchor="middle" fill="#10b981" font-family="monospace" font-size="14">3.7</text>
    <text x="75" y="70" text-anchor="middle" fill="#10b981" font-family="monospace" font-size="14">0.02</text>
    <text x="115" y="70" text-anchor="middle" fill="#10b981" font-family="monospace" font-size="14">6.7</text>

    <text x="35" y="100" text-anchor="middle" fill="#10b981" font-family="monospace" font-size="14">1.1</text>
    <text x="75" y="100" text-anchor="middle" fill="#10b981" font-family="monospace" font-size="14">1.8</text>
    <text x="115" y="100" text-anchor="middle" fill="#10b981" font-family="monospace" font-size="14">0.8</text>

    <!-- Row sums OUTSIDE box on right -->
    <text x="160" y="40" text-anchor="start" fill="#f97316" font-family="system-ui" font-size="10" font-weight="500">Σ=10.7</text>
    <text x="160" y="70" text-anchor="start" fill="#f97316" font-family="system-ui" font-size="10" font-weight="500">Σ=10.4</text>
    <text x="160" y="100" text-anchor="start" fill="#f97316" font-family="system-ui" font-size="10" font-weight="500">Σ=3.7</text>
  </g>

  <!-- Arrow 2 -->
  <g transform="translate(460, 155)">
    <rect x="0" y="-15" width="75" height="30" rx="15" fill="#f97316"/>
    <text x="37" y="5" text-anchor="middle" fill="white" font-family="system-ui" font-size="11" font-weight="600">Normalize</text>
    <text x="37" y="-25" text-anchor="middle" fill="#f97316" font-family="system-ui" font-size="11" font-weight="600">Rows</text>
    <line x1="75" y1="0" x2="95" y2="0" stroke="#f97316" stroke-width="3"/>
    <polygon points="100,0 90,-6 90,6" fill="#f97316"/>
  </g>

  <!-- Step 3: Row Normalized -->
  <g transform="translate(565, 100)">
    <rect x="0" y="0" width="150" height="130" rx="6" fill="white" stroke="#1a365d" stroke-width="2"/>
    <text x="75" y="-12" text-anchor="middle" fill="#1a365d" font-family="system-ui" font-size="15" font-weight="600">Row Normalized</text>

    <text x="35" y="40" text-anchor="middle" fill="#1a365d" font-family="monospace" font-size="14">0.25</text>
    <text x="75" y="40" text-anchor="middle" fill="#1a365d" font-family="monospace" font-size="14">0.65</text>
    <text x="115" y="40" text-anchor="middle" fill="#1a365d" font-family="monospace" font-size="14">0.10</text>

    <text x="35" y="70" text-anchor="middle" fill="#1a365d" font-family="monospace" font-size="14">0.35</text>
    <text x="75" y="70" text-anchor="middle" fill="#1a365d" font-family="monospace" font-size="14">0.01</text>
    <text x="115" y="70" text-anchor="middle" fill="#1a365d" font-family="monospace" font-size="14">0.64</text>

    <text x="35" y="100" text-anchor="middle" fill="#1a365d" font-family="monospace" font-size="14">0.30</text>
    <text x="75" y="100" text-anchor="middle" fill="#1a365d" font-family="monospace" font-size="14">0.45</text>
    <text x="115" y="100" text-anchor="middle" fill="#1a365d" font-family="monospace" font-size="14">0.25</text>

    <!-- Row sums OUTSIDE box on right -->
    <text x="160" y="40" text-anchor="start" fill="#10b981" font-family="system-ui" font-size="10" font-weight="600">Σ=1.0</text>
    <text x="160" y="70" text-anchor="start" fill="#10b981" font-family="system-ui" font-size="10" font-weight="600">Σ=1.0</text>
    <text x="160" y="100" text-anchor="start" fill="#10b981" font-family="system-ui" font-size="10" font-weight="600">Σ=1.0</text>

    <!-- Column sums below box -->
    <text x="35" y="145" text-anchor="middle" fill="#f97316" font-family="system-ui" font-size="9">Σ=0.9</text>
    <text x="75" y="145" text-anchor="middle" fill="#f97316" font-family="system-ui" font-size="9">Σ=1.11</text>
    <text x="115" y="145" text-anchor="middle" fill="#f97316" font-family="system-ui" font-size="9">Σ=0.99</text>
  </g>

  <!-- Arrow 3 -->
  <g transform="translate(760, 155)">
    <rect x="0" y="-15" width="75" height="30" rx="15" fill="#f97316"/>
    <text x="37" y="5" text-anchor="middle" fill="white" font-family="system-ui" font-size="11" font-weight="600">Normalize</text>
    <text x="37" y="-25" text-anchor="middle" fill="#f97316" font-family="system-ui" font-size="11" font-weight="600">Cols</text>
    <line x1="75" y1="0" x2="95" y2="0" stroke="#f97316" stroke-width="3"/>
    <polygon points="100,0 90,-6 90,6" fill="#f97316"/>
  </g>

  <!-- Step 4: Doubly Stochastic -->
  <g transform="translate(860, 100)">
    <rect x="0" y="0" width="150" height="130" rx="6" fill="white" stroke="#10b981" stroke-width="3"/>
    <text x="75" y="-12" text-anchor="middle" fill="#10b981" font-family="system-ui" font-size="14" font-weight="700">Doubly Stochastic</text>

    <text x="35" y="40" text-anchor="middle" fill="#10b981" font-family="monospace" font-size="14" font-weight="500">0.28</text>
    <text x="75" y="40" text-anchor="middle" fill="#10b981" font-family="monospace" font-size="14" font-weight="500">0.45</text>
    <text x="115" y="40" text-anchor="middle" fill="#10b981" font-family="monospace" font-size="14" font-weight="500">0.27</text>

    <text x="35" y="70" text-anchor="middle" fill="#10b981" font-family="monospace" font-size="14" font-weight="500">0.40</text>
    <text x="75" y="70" text-anchor="middle" fill="#10b981" font-family="monospace" font-size="14" font-weight="500">0.09</text>
    <text x="115" y="70" text-anchor="middle" fill="#10b981" font-family="monospace" font-size="14" font-weight="500">0.51</text>

    <text x="35" y="100" text-anchor="middle" fill="#10b981" font-family="monospace" font-size="14" font-weight="500">0.32</text>
    <text x="75" y="100" text-anchor="middle" fill="#10b981" font-family="monospace" font-size="14" font-weight="500">0.46</text>
    <text x="115" y="100" text-anchor="middle" fill="#10b981" font-family="monospace" font-size="14" font-weight="500">0.22</text>

    <!-- Row sums OUTSIDE box on right -->
    <text x="160" y="40" text-anchor="start" fill="#10b981" font-family="system-ui" font-size="10" font-weight="600">→1</text>
    <text x="160" y="70" text-anchor="start" fill="#10b981" font-family="system-ui" font-size="10" font-weight="600">→1</text>
    <text x="160" y="100" text-anchor="start" fill="#10b981" font-family="system-ui" font-size="10" font-weight="600">→1</text>

    <!-- Column sums below box -->
    <text x="35" y="145" text-anchor="middle" fill="#10b981" font-family="system-ui" font-size="9" font-weight="600">↓1</text>
    <text x="75" y="145" text-anchor="middle" fill="#10b981" font-family="system-ui" font-size="9" font-weight="600">↓1</text>
    <text x="115" y="145" text-anchor="middle" fill="#10b981" font-family="system-ui" font-size="9" font-weight="600">↓1</text>
  </g>

  <!-- Iteration loop -->
  <path d="M 935 270 Q 935 320 750 320 Q 670 320 670 275"
        fill="none" stroke="#f97316" stroke-width="2" stroke-dasharray="6,3"/>
  <polygon points="670,270 665,282 675,282" fill="#f97316"/>
  <rect x="720" y="305" width="160" height="28" rx="14" fill="#f97316"/>
  <text x="800" y="324" text-anchor="middle" fill="white" font-family="system-ui" font-size="12" font-weight="600">Repeat t times (t≈20)</text>

  <!-- Bottom explanation -->
  <rect x="150" y="360" width="750" height="70" rx="8" fill="white" stroke="#1a365d" stroke-width="2"/>
  <text x="525" y="390" text-anchor="middle" fill="#1a365d" font-family="system-ui" font-size="14" font-weight="600">The Sinkhorn-Knopp algorithm is computationally efficient</text>
  <text x="525" y="415" text-anchor="middle" fill="#64748b" font-family="system-ui" font-size="13">Allows this constraint to be applied during training without stalling the pipeline.</text>
</svg>
