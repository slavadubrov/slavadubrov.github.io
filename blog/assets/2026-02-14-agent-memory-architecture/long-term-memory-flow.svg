<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 820 380" font-family="'Segoe UI', system-ui, -apple-system, sans-serif">
  <defs>
    <marker id="arrowL" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#555"/>
    </marker>
    <marker id="arrowOrange" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#e65100"/>
    </marker>
    <marker id="arrowPurple" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#6a1b9a"/>
    </marker>
    <filter id="shadowL" x="-2%" y="-2%" width="104%" height="108%">
      <feDropShadow dx="1" dy="2" stdDeviation="2" flood-opacity="0.1"/>
    </filter>
  </defs>

  <!-- Title -->
  <text x="410" y="28" text-anchor="middle" font-size="18" font-weight="700" fill="#1a1a2e">Long-Term Memory: Retrieval Flow</text>

  <!-- === Query Path (top row) === -->
  <rect x="15" y="48" width="790" height="120" rx="10" fill="#fff9f5" stroke="#e65100" stroke-width="1" stroke-dasharray="4"/>
  <text x="30" y="68" font-size="12" font-weight="700" fill="#e65100">Retrieval Path</text>

  <!-- User Query -->
  <rect x="35" y="82" width="110" height="50" rx="8" fill="#f3e5f5" stroke="#6a1b9a" stroke-width="1.5" filter="url(#shadowL)"/>
  <text x="90" y="104" text-anchor="middle" font-size="12" font-weight="600" fill="#6a1b9a">User Query</text>
  <text x="90" y="120" text-anchor="middle" font-size="9" fill="#888">"How do I..."</text>

  <!-- Arrow -->
  <line x1="145" y1="107" x2="175" y2="107" stroke="#e65100" stroke-width="1.5" marker-end="url(#arrowOrange)"/>

  <!-- Embed -->
  <rect x="180" y="82" width="110" height="50" rx="8" fill="#fff3e0" stroke="#e65100" stroke-width="1.5" filter="url(#shadowL)"/>
  <text x="235" y="104" text-anchor="middle" font-size="12" font-weight="600" fill="#e65100">Embed Query</text>
  <text x="235" y="120" text-anchor="middle" font-size="9" fill="#888">text-embedding-3</text>

  <!-- Arrow -->
  <line x1="290" y1="107" x2="320" y2="107" stroke="#e65100" stroke-width="1.5" marker-end="url(#arrowOrange)"/>

  <!-- Vector Search -->
  <rect x="325" y="82" width="140" height="50" rx="8" fill="#fff3e0" stroke="#e65100" stroke-width="1.5" filter="url(#shadowL)"/>
  <text x="395" y="104" text-anchor="middle" font-size="12" font-weight="600" fill="#e65100">Vector Search</text>
  <text x="395" y="120" text-anchor="middle" font-size="9" fill="#888">Qdrant / Pinecone</text>

  <!-- Arrow -->
  <line x1="465" y1="107" x2="495" y2="107" stroke="#e65100" stroke-width="1.5" marker-end="url(#arrowOrange)"/>

  <!-- Top-K Results -->
  <rect x="500" y="82" width="130" height="50" rx="8" fill="#e8f5e9" stroke="#2e7d32" stroke-width="1.5" filter="url(#shadowL)"/>
  <text x="565" y="104" text-anchor="middle" font-size="12" font-weight="600" fill="#2e7d32">Top-K Results</text>
  <text x="565" y="120" text-anchor="middle" font-size="9" fill="#888">Ranked by similarity</text>

  <!-- Arrow -->
  <line x1="630" y1="107" x2="660" y2="107" stroke="#e65100" stroke-width="1.5" marker-end="url(#arrowOrange)"/>

  <!-- Rerank (optional) -->
  <rect x="665" y="82" width="120" height="50" rx="8" fill="#e8f5e9" stroke="#2e7d32" stroke-width="1.5" filter="url(#shadowL)"/>
  <text x="725" y="104" text-anchor="middle" font-size="12" font-weight="600" fill="#2e7d32">Rerank</text>
  <text x="725" y="120" text-anchor="middle" font-size="9" fill="#888">Cross-encoder (opt.)</text>

  <!-- === Injection Path (bottom row) === -->
  <rect x="15" y="190" width="790" height="120" rx="10" fill="#f8f0ff" stroke="#6a1b9a" stroke-width="1" stroke-dasharray="4"/>
  <text x="30" y="210" font-size="12" font-weight="700" fill="#6a1b9a">Context Injection</text>

  <!-- Retrieved Docs -->
  <rect x="35" y="224" width="140" height="50" rx="8" fill="#e8f5e9" stroke="#2e7d32" stroke-width="1.5" filter="url(#shadowL)"/>
  <text x="105" y="246" text-anchor="middle" font-size="12" font-weight="600" fill="#2e7d32">Retrieved Docs</text>
  <text x="105" y="262" text-anchor="middle" font-size="9" fill="#888">K relevant passages</text>

  <!-- Arrow -->
  <line x1="175" y1="249" x2="210" y2="249" stroke="#6a1b9a" stroke-width="1.5" marker-end="url(#arrowPurple)"/>

  <!-- Format Context -->
  <rect x="215" y="224" width="150" height="50" rx="8" fill="#f3e5f5" stroke="#6a1b9a" stroke-width="1.5" filter="url(#shadowL)"/>
  <text x="290" y="246" text-anchor="middle" font-size="12" font-weight="600" fill="#6a1b9a">Format Context</text>
  <text x="290" y="262" text-anchor="middle" font-size="9" fill="#888">Template + citations</text>

  <!-- Arrow -->
  <line x1="365" y1="249" x2="400" y2="249" stroke="#6a1b9a" stroke-width="1.5" marker-end="url(#arrowPurple)"/>

  <!-- Inject into Prompt -->
  <rect x="405" y="224" width="170" height="50" rx="8" fill="#f3e5f5" stroke="#6a1b9a" stroke-width="1.5" filter="url(#shadowL)"/>
  <text x="490" y="246" text-anchor="middle" font-size="12" font-weight="600" fill="#6a1b9a">Inject into Prompt</text>
  <text x="490" y="262" text-anchor="middle" font-size="9" fill="#888">System msg or prefix</text>

  <!-- Arrow -->
  <line x1="575" y1="249" x2="610" y2="249" stroke="#6a1b9a" stroke-width="1.5" marker-end="url(#arrowPurple)"/>

  <!-- LLM Response -->
  <rect x="615" y="224" width="170" height="50" rx="8" fill="#f3e5f5" stroke="#6a1b9a" stroke-width="1.5" filter="url(#shadowL)"/>
  <text x="700" y="246" text-anchor="middle" font-size="12" font-weight="600" fill="#6a1b9a">LLM Generation</text>
  <text x="700" y="262" text-anchor="middle" font-size="9" fill="#888">Grounded response</text>

  <!-- Connecting arrow from retrieval to injection -->
  <path d="M725 132 Q730 160 725 170 Q720 180 400 180 Q80 180 105 220" stroke="#888" stroke-width="1.5" fill="none" stroke-dasharray="5,3" marker-end="url(#arrowL)"/>
  <text x="410" y="176" text-anchor="middle" font-size="9" fill="#888">pass retrieved context down</text>

  <!-- Bottom: Write path note -->
  <rect x="120" y="330" width="580" height="40" rx="8" fill="#f5f5f5" stroke="#999" stroke-width="1"/>
  <text x="410" y="348" text-anchor="middle" font-size="11" font-weight="600" fill="#555">Write Path (ingestion): Documents are chunked, embedded, and stored in vector DB</text>
  <text x="410" y="363" text-anchor="middle" font-size="10" fill="#888">Chunk (512 tokens) --> Embed --> Upsert to Qdrant with metadata</text>
</svg>
