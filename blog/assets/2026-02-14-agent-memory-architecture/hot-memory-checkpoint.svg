<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 780 400" font-family="'Segoe UI', system-ui, -apple-system, sans-serif">
  <defs>
    <marker id="arrowC" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#555"/>
    </marker>
    <marker id="arrowBlue" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#1565c0"/>
    </marker>
    <marker id="arrowGreen" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#2e7d32"/>
    </marker>
    <filter id="shadowC" x="-2%" y="-2%" width="104%" height="108%">
      <feDropShadow dx="1" dy="2" stdDeviation="2" flood-opacity="0.1"/>
    </filter>
  </defs>

  <!-- Title -->
  <text x="390" y="28" text-anchor="middle" font-size="18" font-weight="700" fill="#1a1a2e">Hot Memory: Checkpoint &amp; Recovery Flow</text>

  <!-- === WRITE PATH (top) === -->
  <rect x="20" y="48" width="740" height="145" rx="10" fill="#f5f8ff" stroke="#1565c0" stroke-width="1" stroke-dasharray="4"/>
  <text x="35" y="68" font-size="12" font-weight="700" fill="#1565c0">Write Path: Checkpoint on Every Step</text>

  <!-- Agent Step -->
  <rect x="40" y="82" width="130" height="50" rx="8" fill="#f3e5f5" stroke="#6a1b9a" stroke-width="1.5" filter="url(#shadowC)"/>
  <text x="105" y="105" text-anchor="middle" font-size="12" font-weight="600" fill="#6a1b9a">Agent Step</text>
  <text x="105" y="121" text-anchor="middle" font-size="9" fill="#888">Think / Act / Observe</text>

  <!-- Arrow -->
  <line x1="170" y1="107" x2="205" y2="107" stroke="#1565c0" stroke-width="1.5" marker-end="url(#arrowBlue)"/>
  <text x="188" y="100" text-anchor="middle" font-size="9" fill="#1565c0">after</text>

  <!-- Serialize State -->
  <rect x="210" y="82" width="140" height="50" rx="8" fill="#e3f2fd" stroke="#1565c0" stroke-width="1.5" filter="url(#shadowC)"/>
  <text x="280" y="102" text-anchor="middle" font-size="12" font-weight="600" fill="#1565c0">Serialize State</text>
  <text x="280" y="118" text-anchor="middle" font-size="9" fill="#888">Messages + metadata</text>

  <!-- Arrow -->
  <line x1="350" y1="107" x2="385" y2="107" stroke="#1565c0" stroke-width="1.5" marker-end="url(#arrowBlue)"/>

  <!-- Write Checkpoint -->
  <rect x="390" y="82" width="160" height="50" rx="8" fill="#e3f2fd" stroke="#1565c0" stroke-width="1.5" filter="url(#shadowC)"/>
  <text x="470" y="102" text-anchor="middle" font-size="12" font-weight="600" fill="#1565c0">Write Checkpoint</text>
  <text x="470" y="118" text-anchor="middle" font-size="9" fill="#888">Upsert to store</text>

  <!-- Arrow to stores -->
  <line x1="550" y1="107" x2="585" y2="90" stroke="#1565c0" stroke-width="1.5" marker-end="url(#arrowBlue)"/>
  <line x1="550" y1="107" x2="585" y2="125" stroke="#1565c0" stroke-width="1.5" marker-end="url(#arrowBlue)"/>

  <!-- PostgreSQL -->
  <rect x="590" y="72" width="150" height="34" rx="6" fill="#e3f2fd" stroke="#1565c0" stroke-width="1.5" filter="url(#shadowC)"/>
  <text x="665" y="94" text-anchor="middle" font-size="11" font-weight="600" fill="#1565c0">PostgreSQL</text>

  <!-- Redis -->
  <rect x="590" y="112" width="150" height="34" rx="6" fill="#fce4ec" stroke="#c62828" stroke-width="1.5" filter="url(#shadowC)"/>
  <text x="665" y="134" text-anchor="middle" font-size="11" font-weight="600" fill="#c62828">Redis</text>

  <!-- Step labels -->
  <text x="105" y="150" text-anchor="middle" font-size="9" fill="#aaa">Step N</text>
  <text x="280" y="150" text-anchor="middle" font-size="9" fill="#aaa">JSON / msgpack</text>
  <text x="470" y="150" text-anchor="middle" font-size="9" fill="#aaa">thread_id + step_n</text>
  <text x="665" y="160" text-anchor="middle" font-size="9" fill="#aaa">Durable / Fast</text>

  <!-- === READ PATH (bottom) === -->
  <rect x="20" y="208" width="740" height="150" rx="10" fill="#f5fff7" stroke="#2e7d32" stroke-width="1" stroke-dasharray="4"/>
  <text x="35" y="228" font-size="12" font-weight="700" fill="#2e7d32">Read Path: Resume from Checkpoint</text>

  <!-- Crash / Restart -->
  <rect x="40" y="242" width="130" height="50" rx="8" fill="#fce4ec" stroke="#c62828" stroke-width="1.5" filter="url(#shadowC)"/>
  <text x="105" y="263" text-anchor="middle" font-size="12" font-weight="600" fill="#c62828">Crash / Restart</text>
  <text x="105" y="279" text-anchor="middle" font-size="9" fill="#888">Process terminated</text>

  <!-- Arrow -->
  <line x1="170" y1="267" x2="205" y2="267" stroke="#2e7d32" stroke-width="1.5" marker-end="url(#arrowGreen)"/>

  <!-- Load Checkpoint -->
  <rect x="210" y="242" width="160" height="50" rx="8" fill="#e8f5e9" stroke="#2e7d32" stroke-width="1.5" filter="url(#shadowC)"/>
  <text x="290" y="263" text-anchor="middle" font-size="12" font-weight="600" fill="#2e7d32">Load Checkpoint</text>
  <text x="290" y="279" text-anchor="middle" font-size="9" fill="#888">Fetch latest by thread_id</text>

  <!-- Arrow -->
  <line x1="370" y1="267" x2="405" y2="267" stroke="#2e7d32" stroke-width="1.5" marker-end="url(#arrowGreen)"/>

  <!-- Deserialize -->
  <rect x="410" y="242" width="150" height="50" rx="8" fill="#e8f5e9" stroke="#2e7d32" stroke-width="1.5" filter="url(#shadowC)"/>
  <text x="485" y="263" text-anchor="middle" font-size="12" font-weight="600" fill="#2e7d32">Deserialize</text>
  <text x="485" y="279" text-anchor="middle" font-size="9" fill="#888">Rebuild agent state</text>

  <!-- Arrow -->
  <line x1="560" y1="267" x2="595" y2="267" stroke="#2e7d32" stroke-width="1.5" marker-end="url(#arrowGreen)"/>

  <!-- Resume Execution -->
  <rect x="600" y="242" width="140" height="50" rx="8" fill="#f3e5f5" stroke="#6a1b9a" stroke-width="1.5" filter="url(#shadowC)"/>
  <text x="670" y="263" text-anchor="middle" font-size="12" font-weight="600" fill="#6a1b9a">Resume Agent</text>
  <text x="670" y="279" text-anchor="middle" font-size="9" fill="#888">Continue from Step N</text>

  <!-- Step labels -->
  <text x="105" y="310" text-anchor="middle" font-size="9" fill="#aaa">OOM / timeout / error</text>
  <text x="290" y="310" text-anchor="middle" font-size="9" fill="#aaa">Query checkpoint store</text>
  <text x="485" y="310" text-anchor="middle" font-size="9" fill="#aaa">Restore messages</text>
  <text x="670" y="310" text-anchor="middle" font-size="9" fill="#aaa">No lost progress</text>

  <!-- Bottom note -->
  <rect x="140" y="365" width="500" height="28" rx="14" fill="#f5f5f5" stroke="#999" stroke-width="1"/>
  <text x="390" y="384" text-anchor="middle" font-size="11" fill="#555">Key insight: every step is persisted, so crash recovery is automatic and lossless</text>
</svg>
